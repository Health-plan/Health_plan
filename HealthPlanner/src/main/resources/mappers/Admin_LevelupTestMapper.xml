<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.health.mapper.Admin_LevelupTestMapper">
	
	<resultMap type="LevelupTestDTO" id="selectLevelupTestListResult">
		
		<id column="mbr_id" property="mbrId"/>
		<id column="exercise_id" property="exerciseId"/>
		<id column="test_date" property="testDate"/>
		<result column="modify_date" property="modifyDate"/>
		<result column="evaluation_result" property="evaluationResult"/>
		<result column="appraiser" property="appraiser"/>
		<result column="running_weight" property="runningWeight"/>
		<result column="running_time" property="runningTime"/>
		<result column="video_url" property="videoUrl"/>
		
		<association javaType="LevelPointDTO" property="levelPointDTO">
			<result column="level_nm" property="levelNm"></result>
		</association>
		<association javaType="ExerciseDbDTO" property="exerciseDbDTO">
			<result column="now_level_nm" property="levelNm"/>
		</association>
		
	</resultMap>
	
	<sql id="LevelupTestDTO">		
		test_date,
		mbr_id,
		exercise_id,
		evaluation_result,
		appraiser,
		running_weight,
		running_time,
		video_url,
		registrant,
		modifier,
		modify_date
	</sql>
	
	<!-- 상세보기 -->
	<select id="selectLevelupDetail" parameterType="map" resultMap="selectLevelupTestListResult">
		SELECT
			lvt.mbr_id,
		    	levels.level_nm,
		    	levels.now_level_nm,
			lvt.evaluation_result,
			lvt.exercise_id,
			lvt.appraiser,
			lvt.running_weight,
			lvt.running_time,
			lvt.video_url,
			lvt.test_date,
		    	lvt.modify_date
		FROM
			levelup_test as lvt
		JOIN
		    (SELECT	b.mbr_id, a.level_id, a.level_nm, b.now_level_id, b.level_nm as now_level_nm
				FROM levelpoint AS a
				JOIN (select b.mbr_id, max(a.level_id) as level_id, b.level_id as now_level_id, b.level_nm
						FROM exercise_part_level as a
						JOIN (SELECT a.*, b.mbr_weight, c.level_id
								FROM exercise_db as a
								JOIN member_state as b
								JOIN levelpoint as c
								ON a.level_nm = c.level_nm) as b
						<![CDATA[
						WHERE a.exercise_id = b.exercise_id and a.body_weight <= b.mbr_weight and a.exercise_time <= b.exercise_time) AS b
						]]>
				ON a.level_id = b.level_id) as levels
		
		WHERE
			lvt.test_date = #{testDate}
		AND
			lvt.mbr_id = #{mbrId}
		AND
			lvt.exercise_id = #{exerciseId}
		
	</select>
	
	<!-- 결과입력 -->
	<update id="updateLevelupTest" parameterType="LevelupTestDTO">
		UPDATE
			levelup_test
		SET
		<!-- 현재 관리자명은 'admin'으로 설정 -->
			evaluation_result = #{evaluationResult},
			appraiser = 'admin',
			running_weight = #{runningWeight},
			running_time = #{runningTime},
			modifier = 'admin',
			modify_date = now()
		WHERE
			test_date = #{testDate}
		AND
			mbr_id = #{mbrId}
		AND
			exercise_id = #{exerciseId}
	</update>
	
	<!-- 리스트 -->
	<select id="selectLevelupTestList" parameterType="LevelupTestDTO" resultMap="selectLevelupTestListResult">
		SELECT
			lvt.mbr_id,
		    levels.level_nm,
		    levels.now_level_nm,
			lvt.evaluation_result,
			lvt.exercise_id,
			lvt.test_date,
		    lvt.modify_date
		FROM
			levelup_test as lvt
		JOIN
		    (SELECT	b.mbr_id, a.level_id, a.level_nm, b.now_level_id, b.level_nm as now_level_nm
				FROM levelpoint AS a
				JOIN (select b.mbr_id, max(a.level_id) as level_id, b.level_id as now_level_id, b.level_nm
						from exercise_part_level as a
						join (SELECT a.*, b.mbr_weight, c.level_id
								FROM exercise_db as a
								JOIN member_state as b
								JOIN levelpoint as c
								ON a.level_nm = c.level_nm
		                        ) as b
						<![CDATA[where a.exercise_id = b.exercise_id and a.body_weight <= b.mbr_weight and a.exercise_time <= b.exercise_time) AS b]]>
				ON a.level_id = b.level_id) as levels
		<include refid="CommonMapper.searchLevelup"/>
		ORDER BY
		<choose>
			<when test="sortType == 0">
				modify_date DESC,
				evaluation_result
			</when>		
			<when test="sortType == 1">
				test_date DESC,
				evaluation_result
			</when>			
			<otherwise>
				evaluation_result,
				modify_date DESC,
				test_date DESC
			</otherwise>
		</choose>
		<include refid="CommonMapper.paging"/>
	</select>
	
	<!-- 페이징 전처리 -->
	<select id="selectLevelupTestTotalCount" parameterType="LevelupTestDTO" resultType="int">
		SELECT
			COUNT(*)
		FROM
			levelup_test as lvt
		<include refid="CommonMapper.searchLevelup"/>
	</select>
	
</mapper>